<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Equinox - Registro de Roster para Nueva Expansi√≥n</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getFirestore, doc, setDoc, getDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';
        
        try {
            // Import Firebase configuration from external file
            // To set up: Copy firebase-config.js.example to firebase-config.js and add your credentials
            const { firebaseConfig } = await import('./firebase-config.js');
            
            // Initialize Firebase
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            
            // Make Firebase Firestore functions globally accessible
            window.firestoreDB = db;
            window.firestoreDoc = doc;
            window.firestoreSetDoc = setDoc;
            window.firestoreGetDoc = getDoc;
            window.firestoreOnSnapshot = onSnapshot;
            window.firebaseConfigured = true;
        } catch (error) {
            console.error('Firebase configuration error:', error);
            window.firebaseConfigured = false;
            window.firebaseConfigError = error.message;
        }
    </script>

    <style>
        .roster-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header-section {
            text-align: center;
            margin-bottom: 40px;
        }

        .header-section h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header-section p {
            font-size: 1.2em;
            color: #a78bfa;
        }

        .content-layout {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .signup-section, .roster-section {
            background-color: rgba(30, 41, 59, 0.8);
            padding: 25px;
            border-radius: 12px;
            border: 2px solid var(--dorado);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        .signup-section h2, .roster-section h2 {
            margin-top: 0;
            border-bottom: 2px solid var(--dorado);
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--dorado);
            font-weight: bold;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            box-sizing: border-box;
        }

        .role-selection {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .role-checkbox {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .role-checkbox input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        .role-checkbox label {
            margin: 0;
            font-weight: normal;
            color: white;
        }

        .btn-submit {
            width: 100%;
            padding: 15px;
            font-size: 1.1em;
            font-weight: bold;
            margin-top: 20px;
        }

        .filters {
            margin-bottom: 20px;
        }

        .roster-table {
            width: 100%;
            overflow-x: auto;
        }

        .roster-table table {
            width: 100%;
        }

        .role-badge {
            display: inline-block;
            padding: 3px 8px;
            margin: 2px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: bold;
        }

        .role-tank {
            background-color: #3b82f6;
            color: white;
        }

        .role-healer {
            background-color: #10b981;
            color: white;
        }

        .role-dps {
            background-color: #ef4444;
            color: white;
        }

        .delete-btn {
            background-color: #dc2626;
            padding: 5px 10px;
            font-size: 0.85em;
        }

        .delete-btn:hover {
            background-color: #991b1b;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background-color: rgba(30, 41, 59, 0.8);
            padding: 20px;
            border-radius: 8px;
            border: 2px solid var(--purpura);
            text-align: center;
        }

        .stat-card h3 {
            margin: 0 0 10px 0;
            color: var(--dorado);
            font-size: 1.1em;
        }

        .stat-card .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: var(--verde-epico);
        }

        @media (max-width: 1024px) {
            .content-layout {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="roster-container">
        <div class="back-to-home-wrapper">
            <a href="index.html" class="back-to-home">‚Üê Volver al Inicio</a>
        </div>
        <div class="header-section">
            <h1>üõ°Ô∏è Registro de Roster - Pr√≥xima Expansi√≥n üõ°Ô∏è</h1>
            <p>Apunta tu clase y rol para ayudar a los oficiales a organizar el roster</p>
        </div>

        <!-- Summary Statistics -->
        <div class="summary-stats">
            <div class="stat-card">
                <h3>Total Inscritos</h3>
                <div class="stat-value" id="stat-total">0</div>
            </div>
            <div class="stat-card">
                <h3>Tanks</h3>
                <div class="stat-value" id="stat-tanks">0</div>
            </div>
            <div class="stat-card">
                <h3>Healers</h3>
                <div class="stat-value" id="stat-healers">0</div>
            </div>
            <div class="stat-card">
                <h3>DPS</h3>
                <div class="stat-value" id="stat-dps">0</div>
            </div>
        </div>

        <div class="content-layout">
            <!-- Signup Form Section -->
            <div class="signup-section">
                <h2>üìù Registrar Personaje</h2>
                <form id="signup-form">
                    <div class="form-group">
                        <label for="player-name">Nombre del Personaje *</label>
                        <input type="text" id="player-name" required placeholder="Nombre del personaje">
                    </div>

                    <div class="form-group">
                        <label for="player-class">Clase *</label>
                        <select id="player-class" required>
                            <option value="">Selecciona tu clase</option>
                            <option value="Guerrero">Guerrero</option>
                            <option value="Mago">Mago</option>
                            <option value="Sacerdote">Sacerdote</option>
                            <option value="Palad√≠n">Palad√≠n</option>
                            <option value="Cazador">Cazador</option>
                            <option value="Brujo">Brujo</option>
                            <option value="Cham√°n">Cham√°n</option>
                            <option value="Druida">Druida</option>
                            <option value="P√≠caro">P√≠caro</option>
                            <option value="Caballero de la Muerte">Caballero de la Muerte</option>
                            <option value="Monje">Monje</option>
                            <option value="Cazador de Demonios">Cazador de Demonios</option>
                            <option value="Evocador">Evocador</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="player-spec">Especializaci√≥n *</label>
                        <select id="player-spec" required>
                            <option value="">Selecciona clase primero</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Roles que puedes desempe√±ar *</label>
                        <div class="role-selection">
                            <div class="role-checkbox">
                                <input type="checkbox" id="role-tank" value="Tank">
                                <label for="role-tank">Tank</label>
                            </div>
                            <div class="role-checkbox">
                                <input type="checkbox" id="role-healer" value="Healer">
                                <label for="role-healer">Healer</label>
                            </div>
                            <div class="role-checkbox">
                                <input type="checkbox" id="role-dps" value="DPS">
                                <label for="role-dps">DPS</label>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="player-notes">Notas Adicionales (opcional)</label>
                        <input type="text" id="player-notes" placeholder="Ej: Prefiero Main Tank, tengo alts, etc.">
                    </div>

                    <button type="submit" class="btn-submit">‚úÖ Registrar</button>
                </form>
            </div>

            <!-- Roster Display Section -->
            <div class="roster-section">
                <h2>üìä Roster Actual</h2>
                
                <div class="filters">
                    <label>Filtrar por Clase:</label>
                    <select id="filter-class">
                        <option value="">Todas las Clases</option>
                        <option value="Guerrero">Guerrero</option>
                        <option value="Mago">Mago</option>
                        <option value="Sacerdote">Sacerdote</option>
                        <option value="Palad√≠n">Palad√≠n</option>
                        <option value="Cazador">Cazador</option>
                        <option value="Brujo">Brujo</option>
                        <option value="Cham√°n">Cham√°n</option>
                        <option value="Druida">Druida</option>
                        <option value="P√≠caro">P√≠caro</option>
                        <option value="Caballero de la Muerte">Caballero de la Muerte</option>
                        <option value="Monje">Monje</option>
                        <option value="Cazador de Demonios">Cazador de Demonios</option>
                        <option value="Evocador">Evocador</option>
                    </select>

                    <label style="margin-left: 15px;">Filtrar por Rol:</label>
                    <select id="filter-role">
                        <option value="">Todos los Roles</option>
                        <option value="Tank">Tank</option>
                        <option value="Healer">Healer</option>
                        <option value="DPS">DPS</option>
                    </select>

                    <button id="btn-export-excel" style="margin-left: 20px;">üì• Exportar a Excel</button>
                </div>

                <div class="roster-table">
                    <table id="roster-table">
                        <thead>
                            <tr>
                                <th>Personaje</th>
                                <th>Clase</th>
                                <th>Especializaci√≥n</th>
                                <th>Roles</th>
                                <th>Notas</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="roster-tbody">
                            <!-- Roster entries will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Specialization data for each class
        const classSpecializations = {
            'Guerrero': ['Armas', 'Furia', 'Protecci√≥n'],
            'Mago': ['Arcano', 'Fuego', 'Escarcha'],
            'Sacerdote': ['Disciplina', 'Sagrado', 'Sombra'],
            'Palad√≠n': ['Sagrado', 'Protecci√≥n', 'Represi√≥n'],
            'Cazador': ['Bestias', 'Punter√≠a', 'Supervivencia'],
            'Brujo': ['Aflicci√≥n', 'Demonolog√≠a', 'Destrucci√≥n'],
            'Cham√°n': ['Elemental', 'Mejora', 'Restauraci√≥n'],
            'Druida': ['Equilibrio', 'Feral', 'Guardi√°n', 'Restauraci√≥n'],
            'P√≠caro': ['Asesinato', 'Forajido', 'Sutileza'],
            'Caballero de la Muerte': ['Sangre', 'Escarcha', 'Profano'],
            'Monje': ['Maestro Cervecero', 'Tejedor de Niebla', 'Viajero del Viento'],
            'Cazador de Demonios': ['Devastaci√≥n', 'Venganza'],
            'Evocador': ['Devastaci√≥n', 'Preservaci√≥n', 'Aumento']
        };

        // Global roster data
        let rosterSignups = [];

        // Initialize Firebase listeners
        function initializeFirebase() {
            if (!window.firestoreDB) {
                console.error('Firebase not initialized');
                return;
            }

            // Listen to roster signups in real-time
            const rosterDoc = window.firestoreDoc(window.firestoreDB, 'rosterSignups', 'expansion');
            window.firestoreOnSnapshot(rosterDoc, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    rosterSignups = data.signups || [];
                } else {
                    rosterSignups = [];
                }
                renderRoster();
                updateStatistics();
            });
        }

        // Save roster to Firebase
        async function saveRosterToFirebase() {
            try {
                const rosterDoc = window.firestoreDoc(window.firestoreDB, 'rosterSignups', 'expansion');
                await window.firestoreSetDoc(rosterDoc, { signups: rosterSignups });
                console.log('Roster saved successfully');
            } catch (error) {
                console.error('Error saving roster:', error);
                alert('Error al guardar. Por favor, intenta de nuevo.');
            }
        }

        // Update class specialization dropdown when class is selected
        document.getElementById('player-class').addEventListener('change', function() {
            const selectedClass = this.value;
            const specSelect = document.getElementById('player-spec');
            specSelect.innerHTML = '<option value="">Selecciona especializaci√≥n</option>';

            if (selectedClass && classSpecializations[selectedClass]) {
                classSpecializations[selectedClass].forEach(spec => {
                    const option = document.createElement('option');
                    option.value = spec;
                    option.textContent = spec;
                    specSelect.appendChild(option);
                });
            }
        });

        // Handle form submission
        document.getElementById('signup-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            const playerName = document.getElementById('player-name').value.trim();
            const playerClass = document.getElementById('player-class').value;
            const playerSpec = document.getElementById('player-spec').value;
            const playerNotes = document.getElementById('player-notes').value.trim();

            // Get selected roles
            const roles = [];
            if (document.getElementById('role-tank').checked) roles.push('Tank');
            if (document.getElementById('role-healer').checked) roles.push('Healer');
            if (document.getElementById('role-dps').checked) roles.push('DPS');

            // Validation
            if (!playerName || !playerClass || !playerSpec) {
                alert('Por favor, completa todos los campos obligatorios.');
                return;
            }

            if (roles.length === 0) {
                alert('Por favor, selecciona al menos un rol.');
                return;
            }

            // Check if player already exists
            const existingIndex = rosterSignups.findIndex(signup => 
                signup.name.toLowerCase() === playerName.toLowerCase()
            );

            const newSignup = {
                name: playerName,
                class: playerClass,
                specialization: playerSpec,
                roles: roles,
                notes: playerNotes,
                timestamp: new Date().toISOString()
            };

            if (existingIndex >= 0) {
                // Update existing signup
                if (confirm(`${playerName} ya est√° registrado. ¬øQuieres actualizar su informaci√≥n?`)) {
                    rosterSignups[existingIndex] = newSignup;
                } else {
                    return;
                }
            } else {
                // Add new signup
                rosterSignups.push(newSignup);
            }

            await saveRosterToFirebase();

            // Reset form
            this.reset();
            alert('¬°Registro completado con √©xito!');
        });

        // Render roster table
        function renderRoster() {
            const tbody = document.getElementById('roster-tbody');
            const filterClass = document.getElementById('filter-class').value;
            const filterRole = document.getElementById('filter-role').value;

            // Filter signups
            let filteredSignups = rosterSignups;
            if (filterClass) {
                filteredSignups = filteredSignups.filter(s => s.class === filterClass);
            }
            if (filterRole) {
                filteredSignups = filteredSignups.filter(s => s.roles.includes(filterRole));
            }

            tbody.innerHTML = '';

            if (filteredSignups.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No hay registros a√∫n</td></tr>';
                return;
            }

            filteredSignups.forEach((signup, index) => {
                const row = document.createElement('tr');
                
                // Roles badges
                const rolesBadges = signup.roles.map(role => {
                    const roleClass = role.toLowerCase();
                    return `<span class="role-badge role-${roleClass}">${role}</span>`;
                }).join('');

                row.innerHTML = `
                    <td>${signup.name}</td>
                    <td>${signup.class}</td>
                    <td>${signup.specialization}</td>
                    <td>${rolesBadges}</td>
                    <td>${signup.notes || '-'}</td>
                    <td>
                        <button class="delete-btn" onclick="deleteSignup('${signup.name}')">üóëÔ∏è Borrar</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Delete signup
        window.deleteSignup = async function(playerName) {
            if (!confirm(`¬øEst√°s seguro de que quieres eliminar a ${playerName}?`)) {
                return;
            }

            rosterSignups = rosterSignups.filter(s => s.name !== playerName);
            await saveRosterToFirebase();
        };

        // Update statistics
        function updateStatistics() {
            document.getElementById('stat-total').textContent = rosterSignups.length;
            
            const tanks = rosterSignups.filter(s => s.roles.includes('Tank')).length;
            const healers = rosterSignups.filter(s => s.roles.includes('Healer')).length;
            const dps = rosterSignups.filter(s => s.roles.includes('DPS')).length;

            document.getElementById('stat-tanks').textContent = tanks;
            document.getElementById('stat-healers').textContent = healers;
            document.getElementById('stat-dps').textContent = dps;
        }

        // Filter change listeners
        document.getElementById('filter-class').addEventListener('change', renderRoster);
        document.getElementById('filter-role').addEventListener('change', renderRoster);

        // Export to Excel
        document.getElementById('btn-export-excel').addEventListener('click', function() {
            if (rosterSignups.length === 0) {
                alert('No hay datos para exportar.');
                return;
            }

            // Get current date for header and filename
            const currentDate = new Date();
            const year = currentDate.getFullYear();
            const month = String(currentDate.getMonth() + 1).padStart(2, '0');
            const day = String(currentDate.getDate()).padStart(2, '0');
            const dateStr = `${year}-${month}-${day}`;
            
            const displayDate = currentDate.toLocaleDateString('es-ES', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            // Prepare data for Excel
            const exportData = rosterSignups.map(signup => ({
                'Personaje': signup.name,
                'Clase': signup.class,
                'Especializaci√≥n': signup.specialization,
                'Roles': signup.roles.join(', '),
                'Notas': signup.notes || '',
                'Fecha Registro': new Date(signup.timestamp).toLocaleString('es-ES')
            }));

            // Create workbook
            const workbook = XLSX.utils.book_new();
            
            // Create worksheet with title header
            const titleRow = [`EQUINOX - REGISTRO DE ROSTER - ${displayDate}`];
            const emptyRow = [];
            
            // Get headers from first data object
            const headers = Object.keys(exportData[0] || {});
            
            // Build complete data array with title, spacing, headers, and data rows
            const worksheetData = [
                titleRow,
                emptyRow,
                headers,
                ...exportData.map(obj => headers.map(key => obj[key]))
            ];
            
            // Create worksheet from array
            const worksheet = XLSX.utils.aoa_to_sheet(worksheetData);
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Roster');
            
            // Get range of worksheet
            const range = XLSX.utils.decode_range(worksheet['!ref']);
            
            // Define border styles
            const thinBorder = { style: "thin" };
            const createBorder = (color) => ({
                top: { ...thinBorder, color: { rgb: color } },
                bottom: { ...thinBorder, color: { rgb: color } },
                left: { ...thinBorder, color: { rgb: color } },
                right: { ...thinBorder, color: { rgb: color } }
            });
            
            // Style title header (row 0)
            const titleCell = worksheet['A1'];
            if (titleCell) {
                titleCell.s = {
                    font: { 
                        bold: true, 
                        sz: 16,
                        color: { rgb: "FFFFFF" }
                    },
                    fill: { 
                        fgColor: { rgb: "1F4E78" } // Dark blue
                    },
                    alignment: { 
                        horizontal: "center", 
                        vertical: "center" 
                    }
                };
            }
            
            // Merge cells for title header
            worksheet['!merges'] = worksheet['!merges'] || [];
            worksheet['!merges'].push({
                s: { r: 0, c: 0 },
                e: { r: 0, c: range.e.c }
            });
            
            // Style column headers (row 2)
            const headerStyle = {
                font: { 
                    bold: true, 
                    sz: 12,
                    color: { rgb: "FFFFFF" }
                },
                fill: { 
                    fgColor: { rgb: "4472C4" } // Blue
                },
                alignment: { 
                    horizontal: "center", 
                    vertical: "center" 
                },
                border: createBorder("000000")
            };
            
            // Apply header styling
            for (let col = range.s.c; col <= range.e.c; col++) {
                const cellAddress = XLSX.utils.encode_cell({ r: 2, c: col });
                const cell = worksheet[cellAddress];
                if (cell) {
                    cell.s = headerStyle;
                }
            }
            
            // Apply zebra striping and cell styling to data rows
            // Row 0: Title, Row 1: Empty, Row 2: Headers, Row 3+: Data
            const DATA_START_ROW = 3;
            for (let row = DATA_START_ROW; row <= range.e.r; row++) {
                // Calculate even/odd for zebra striping (relative to data rows)
                const isEvenRow = ((row - DATA_START_ROW) % 2) === 0;
                
                for (let col = range.s.c; col <= range.e.c; col++) {
                    const cellAddress = XLSX.utils.encode_cell({ r: row, c: col });
                    const cell = worksheet[cellAddress];
                    if (!cell) continue;
                    
                    // Base style for data cells
                    const cellStyle = {
                        font: { sz: 11 },
                        alignment: { 
                            vertical: "center",
                            horizontal: "left"
                        },
                        border: createBorder("D3D3D3")
                    };
                    
                    // Zebra striping
                    if (isEvenRow) {
                        cellStyle.fill = { fgColor: { rgb: "F2F2F2" } }; // Light gray
                    } else {
                        cellStyle.fill = { fgColor: { rgb: "FFFFFF" } }; // White
                    }
                    
                    // Get column header to determine column
                    const headerAddress = XLSX.utils.encode_cell({ r: 2, c: col });
                    const headerValue = worksheet[headerAddress]?.v || '';
                    
                    // Center align certain columns
                    if (headerValue === 'Roles' || headerValue === 'Clase') {
                        cellStyle.alignment.horizontal = "center";
                    }
                    
                    // Special styling for Roles column
                    if (headerValue === 'Roles') {
                        cellStyle.font.bold = true;
                        cellStyle.font.color = { rgb: "1F4E78" };
                    }
                    
                    cell.s = cellStyle;
                }
            }
            
            // Set column widths
            const colWidths = [
                { wch: 20 }, // Personaje
                { wch: 25 }, // Clase
                { wch: 20 }, // Especializaci√≥n
                { wch: 25 }, // Roles
                { wch: 40 }, // Notas
                { wch: 22 }  // Fecha Registro
            ];
            worksheet['!cols'] = colWidths;
            
            // Set row heights
            worksheet['!rows'] = [];
            worksheet['!rows'][0] = { hpt: 30 }; // Title row height

            // Save file
            const fileName = `Roster_Expansion_${dateStr}.xlsx`;
            XLSX.writeFile(workbook, fileName);
        });

        // Initialize when DOM is ready
        window.addEventListener('load', function() {
            // Setup instructions constant
            const FIREBASE_SETUP_INSTRUCTIONS = '\n\nPara configurar Firebase:\n\n' +
                '1. Copia el archivo client/firebase-config.js.example a client/firebase-config.js\n' +
                '2. Edita firebase-config.js con tus credenciales de Firebase\n' +
                '3. Recarga la p√°gina\n\n' +
                'Para m√°s informaci√≥n, consulta docs/FIREBASE_SETUP.md';
            
            // Wait a bit for Firebase to initialize
            setTimeout(() => {
                // Check if Firebase configuration was attempted and failed
                if (window.firebaseConfigured === false) {
                    console.error('Firebase configuration not found');
                    alert('Error: No se pudo conectar con la base de datos.' + FIREBASE_SETUP_INSTRUCTIONS);
                } else if (window.firestoreDB) {
                    initializeFirebase();
                } else {
                    // Firebase SDK failed to load or config is missing
                    console.error('Firebase not available');
                    if (window.firebaseConfigured === undefined) {
                        // SDK failed to load entirely - likely missing config
                        alert('Error: No se pudo conectar con la base de datos.' + FIREBASE_SETUP_INSTRUCTIONS);
                    } else {
                        alert('Error: No se pudo conectar con la base de datos. Por favor, verifica tu conexi√≥n a internet.');
                    }
                }
            }, 1000);
        });
    </script>
</body>
</html>
